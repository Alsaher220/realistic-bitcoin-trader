<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BTC Trader - Admin Dashboard</title>
  <style>
    body { font-family: Arial; background:#111; color:#eee; margin:0; }
    header { background:#f7931a; padding:15px; display:flex; justify-content:space-between; align-items:center; font-weight:bold; }
    button { padding:5px 10px; border:none; border-radius:4px; cursor:pointer; }
    .logout { background:#d9534f; color:#fff; }
    .logout:hover { background:#c9302c; }
    h2 { border-bottom:2px solid #f7931a; margin-top:30px; padding-bottom:5px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; background:#222; }
    th,td { border:1px solid #444; padding:8px; text-align:center; }
    th { background:#f7931a; color:#000; }
  </style>
</head>
<body>
  <header>
    <div>BTC Trader - Admin Dashboard</div>
    <button class="logout" onclick="logout()">Logout</button>
  </header>

  <div class="container" style="padding:20px;">
    <h2>Users</h2>
    <table id="usersTable">
      <thead><tr><th>Username</th><th>Cash</th><th>BTC</th><th>Top Up</th></tr></thead>
      <tbody></tbody>
    </table>

    <h2>Trade History</h2>
    <table id="tradesTable">
      <thead><tr><th>User</th><th>Date</th><th>Type</th><th>Amount</th><th>Price</th></tr></thead>
      <tbody></tbody>
    </table>

    <h2>Withdrawals</h2>
    <table id="withdrawalsTable">
      <thead><tr><th>User</th><th>Date</th><th>Amount</th><th>Wallet</th><th>Status</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function loadUsers() {
      const res = await fetch('/admin/users');
      const data = await res.json();
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = "";
      data.users.forEach(u => {
        tbody.innerHTML += `
          <tr>
            <td>${u.username}</td>
            <td>$${u.cash}</td>
            <td>${u.btc} BTC</td>
            <td>
              <input type="number" id="cash-${u.id}" placeholder="Cash">
              <input type="number" id="btc-${u.id}" placeholder="BTC">
              <button onclick="topUp(${u.id})">Top Up</button>
            </td>
          </tr>
        `;
      });
    }

    async function loadTrades() {
      const res = await fetch('/admin/trades');
      const data = await res.json();
      const tbody = document.querySelector("#tradesTable tbody");
      tbody.innerHTML = "";
      data.trades.forEach(t => {
        tbody.innerHTML += `
          <tr>
            <td>${t.username}</td>
            <td>${new Date(t.date).toLocaleString()}</td>
            <td>${t.type}</td>
            <td>${t.amount}</td>
            <td>${t.price}</td>
          </tr>
        `;
      });
    }

    async function loadWithdrawals() {
      const res = await fetch('/admin/withdrawals');
      const data = await res.json();
      const tbody = document.querySelector("#withdrawalsTable tbody");
      tbody.innerHTML = "";
      data.withdrawals.forEach(w => {
        tbody.innerHTML += `
          <tr>
            <td>${w.username}</td>
            <td>${new Date(w.date).toLocaleString()}</td>
            <td>$${w.amount}</td>
            <td>${w.wallet}</td>
            <td>${w.status}</td>
            <td>
              ${w.status === 'pending' ? `<button onclick="processWithdrawal(${w.id})">Process</button>` : "âœ… Processed"}
            </td>
          </tr>
        `;
      });
    }

    async function topUp(userId) {
      const cash = parseFloat(document.getElementById(`cash-${userId}`).value) || 0;
      const btc = parseFloat(document.getElementById(`btc-${userId}`).value) || 0;
      await fetch('/admin/topup', {
        method: 'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userId, cash, btc })
      });
      loadUsers();
    }

    async function processWithdrawal(id) {
      await fetch('/admin/withdrawals/process', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id })
      });
      loadWithdrawals();
    }

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    loadUsers(); loadTrades(); loadWithdrawals();
  </script>
</body>
</html>

<!-- /public/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TradeSphere User Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* About Company Modal Styling */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0,0,0,0.6);
    }
    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    .close {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #333;
    }
    .close:hover {
      color: red;
    }
    .messages-box {
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      display: none; /* Hidden initially */
    }
    .alert {
      padding: 10px;
      margin-top: 5px;
      display: none;
      border-radius: 5px;
    }
    .alert.success {
      background-color: #d4edda;
      color: #155724;
    }
    .alert.error {
      background-color: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <header>
    <img src="B10CD185-B0B2-4ACF-9906-CF907D46B9D6.png" alt="TradeSphere Logo" class="logo">
    <h1>TradeSphere</h1>
    <button id="logoutBtn">Logout</button>
  </header>

  <div class="container">
    <section class="account-info card">
      <h2>Account Info</h2>
      <p>Username: <span id="username">-</span></p>
      <p>Cash: $<span id="cash">0.00</span></p>
      <p>BTC: <span id="btc">0.000000</span> BTC</p>
    </section>

    <section class="withdrawals card">
      <h2>Withdrawals</h2>
      <table id="withdrawalsTable">
        <thead>
          <tr>
            <th>Amount</th>
            <th>Wallet</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="investments card">
      <h2>Investments</h2>
      <table id="investmentsTable">
        <thead>
          <tr>
            <th>Plan</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Withdraw Section -->
    <section class="withdraw card">
      <h2>Withdraw</h2>
      <form id="withdrawForm">
        <input type="number" id="withdrawAmount" placeholder="Amount" required>
        <input type="text" id="withdrawWallet" placeholder="Wallet Address" required>
        <button type="submit">Withdraw</button>
      </form>
      <div id="withdrawAlert" class="alert"></div>
    </section>

    <!-- Support Section -->
    <section class="support card">
      <h2>Support</h2>
      <button id="openSupportBtn">Open Chat</button>
      <div id="supportMessages" class="messages-box"></div>
      <form id="supportForm">
        <textarea id="supportMessage" placeholder="Type your message..." required></textarea>
        <button type="submit">Send</button>
      </form>
      <div id="supportAlert" class="alert"></div>
      <p class="support-contact">
        ðŸ“ž +1 (321) 283-6093<br>
        ðŸ“§ support@tradesphere.com
      </p>
    </section>

    <!-- About Company Button -->
    <section class="about card">
      <button id="aboutBtn">About Company</button>
    </section>
  </div>

  <!-- About Company Modal -->
  <div id="aboutModal" class="modal">
    <div class="modal-content">
      <span class="close" id="aboutClose">&times;</span>
      <h2>About TradeSphere</h2>
      <p>
        Since 2020, <strong>TradeSphere</strong> has been a trusted broker platform dedicated to providing users with secure and reliable digital asset trading and investment opportunities. 
        Over the years, we have built a reputation for innovation, transparency, and client satisfaction. Our mission is simple: to empower every investor, regardless of experience level, 
        with the tools and support they need to succeed.  

        From seamless Bitcoin investments to professional support services, TradeSphere ensures every clientâ€™s funds are handled with the highest standards of security.  
        Our advanced systems are built to protect assets while offering a smooth and professional trading experience.  

        Today, thousands of investors trust us for their financial growth. We remain committed to staying ahead of the market, 
        delivering excellence, and keeping every user happy with consistent, reliable service.  
        
        With TradeSphere, your success is our priority â€” and we continue to prove it every single day.
      </p>
    </div>
  </div>

  <footer>
    &copy; 2020 TradeSphere
  </footer>

  <script>
    const userId = localStorage.getItem('userId');
    if (!userId) window.location.href = 'index.html';

    const usernameSpan = document.getElementById('username');
    const cashSpan = document.getElementById('cash');
    const btcSpan = document.getElementById('btc');
    const withdrawalsTable = document.querySelector('#withdrawalsTable tbody');
    const investmentsTable = document.querySelector('#investmentsTable tbody');
    const withdrawAlert = document.getElementById('withdrawAlert');
    const supportAlert = document.getElementById('supportAlert'); 
    const supportMessagesBox = document.getElementById('supportMessages');
    const supportForm = document.getElementById('supportForm');
    const supportMessageInput = document.getElementById('supportMessage');
    const openSupportBtn = document.getElementById('openSupportBtn');

    const START_CASH = 50;

    // ==========================
    // Show Alerts
    // ==========================
    function showAlert(el, msg, isSuccess = true) {
      if (!el) return;
      el.textContent = msg;
      el.className = `alert ${isSuccess ? 'success' : 'error'}`;
      el.style.display = 'block';
      setTimeout(() => (el.style.display = 'none'), 3000);
    }

    // ==========================
    // Fetch User Data
    // ==========================
    async function fetchUserData() {
      try {
        const res = await fetch(`/user/${userId}`);
        const data = await res.json();

        if (!data.success) return;

        const user = data.user;

        usernameSpan.textContent = user.preferred_name || user.preferredName || user.username || 'Unknown';

        let cash = parseFloat(user.cash);
        if (isNaN(cash) || cash === null) cash = START_CASH;
        cashSpan.textContent = cash.toFixed(2);

        let btc = parseFloat(user.btc);
        if (isNaN(btc) || btc === null) btc = 0;
        btcSpan.textContent = btc.toFixed(6);

        renderWithdrawals(data.withdrawals || []);
        renderInvestments(data.investments || []);
        renderSupportMessages(data.supportMessages || []);
      } catch (err) {
        console.error('Error fetching user data:', err);
      }
    }

    // ==========================
    // Render Withdrawals
    // ==========================
    function renderWithdrawals(withdrawals = []) {
      withdrawalsTable.innerHTML = '';
      if (withdrawals.length === 0) {
        withdrawalsTable.innerHTML = `<tr><td colspan="4" style="text-align:center;">No withdrawals yet</td></tr>`;
        return;
      }

      withdrawals.forEach(w => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${parseFloat(w.amount || 0).toFixed(2)}</td>
          <td>${w.wallet || '-'}</td>
          <td>${w.status || 'Pending'}</td>
          <td>${new Date(w.date || Date.now()).toLocaleString()}</td>
        `;
        withdrawalsTable.appendChild(row);
      });
    }

    // ==========================
    // Render Investments
    // ==========================
    function renderInvestments(investments = []) {
      investmentsTable.innerHTML = '';
      if (investments.length === 0) {
        investmentsTable.innerHTML = `<tr><td colspan="4" style="text-align:center;">No investments yet</td></tr>`;
        return;
      }

      investments.forEach(inv => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${inv.plan || '-'}</td>
          <td>${parseFloat(inv.amount || 0).toFixed(2)}</td>
          <td>${inv.status || 'Pending'}</td>
          <td>${new Date(inv.created_at || Date.now()).toLocaleString()}</td>
        `;
        investmentsTable.appendChild(row);
      });
    }

    // ==========================
    // Render Support Messages
    // ==========================
    function renderSupportMessages(messages = []) {
      if (!supportMessagesBox) return;

      supportMessagesBox.innerHTML = '';
      if (messages.length === 0) {
        supportMessagesBox.innerHTML = `<p style="text-align:center;color:#666;">No messages yet.</p>`;
        return;
      }

      messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'support-message';
        div.style.borderBottom = '1px solid #ddd';
        div.style.padding = '5px 0';

        const senderLabel = msg.sender === 'user' ? 'You' : 'Support';
        const messageText = msg.message || msg.text || '';
        const timestamp = msg.created_at || msg.date || Date.now();

        div.innerHTML = `
          <strong>${senderLabel}:</strong> ${messageText}<br>
          <small style="color:#888;">${new Date(timestamp).toLocaleString()}</small>
        `;
        supportMessagesBox.appendChild(div);
      });

      supportMessagesBox.scrollTop = supportMessagesBox.scrollHeight;
      supportMessagesBox._currentMessages = messages;
    }

    // ==========================
    // Withdraw Functionality
    // ==========================
    document.getElementById('withdrawForm')?.addEventListener('submit', async e => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('withdrawAmount').value);
      const wallet = document.getElementById('withdrawWallet').value;

      try {
        const res = await fetch('/withdraw', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, amount, wallet })
        });
        const data = await res.json();
        showAlert(withdrawAlert, data.message, data.success);
        fetchUserData();
        e.target.reset();
      } catch (err) {
        showAlert(withdrawAlert, 'Error requesting withdrawal', false);
      }
    });

    // ==========================
    // Support - Send Message
    // ==========================
    supportForm?.addEventListener('submit', async e => {
      e.preventDefault();
      const message = supportMessageInput.value.trim();
      if (!message) return;

      try {
        const res = await fetch('/support/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, message })
        });
        const data = await res.json();

        if (data.success) {
          showAlert(supportAlert, data.message || 'Message sent to support!', true);

          const newMsg = { sender: 'user', message, created_at: Date.now() };
          const updatedMessages = [...(supportMessagesBox._currentMessages || []), newMsg];
          renderSupportMessages(updatedMessages);

          supportMessageInput.value = '';
        } else {
          showAlert(supportAlert, data.message || 'Failed to send message', false);
        }
      } catch (err) {
        showAlert(supportAlert, 'Error sending support message', false);
        console.error(err);
      }
    });

    // ==========================
    // Open Support Chat
    // ==========================
    openSupportBtn?.addEventListener('click', () => {
      if (supportMessagesBox.style.display === 'none' || supportMessagesBox.style.display === '') {
        supportMessagesBox.style.display = 'block';
      } else {
        supportMessagesBox.style.display = 'none';
      }
    });

    // ==========================
    // About Company Modal Logic
    // ==========================
    const aboutBtn = document.getElementById('aboutBtn');
    const aboutModal = document.getElementById('aboutModal');
    const aboutClose = document.getElementById('aboutClose');

    if (aboutBtn && aboutModal && aboutClose) {
      aboutBtn.addEventListener('click', () => {
        aboutModal.style.display = 'block';
      });

      aboutClose.addEventListener('click', () => {
        aboutModal.style.display = 'none';
      });

      window.addEventListener('click', e => {
        if (e.target === aboutModal) {
          aboutModal.style.display = 'none';
        }
      });
    }

    // ==========================
    // Logout
    // ==========================
    function logout() {
      localStorage.removeItem('userId');
      window.location.href = 'index.html';
    }
    document.getElementById('logoutBtn')?.addEventListener('click', logout);

    // ==========================
    // Initial fetch + auto-refresh
    // ==========================
    fetchUserData();
    setInterval(fetchUserData, 5000);
  </script>
</body>
</html>

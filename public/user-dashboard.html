<!-- /public/user-dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TradeSphere User Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0,0,0,0.85);
    }
    .modal-content {
      background: #1b1b1b;
      margin: 10% auto;
      padding: 30px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      color: #f0f0f0;
    }
    .modal-content h2 {
      color: #FFD700;
      margin-bottom: 15px;
    }
    .modal-content p {
      color: #f0f0f0;
      font-size: 16px;
      line-height: 1.8;
    }
    .close {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #FFD700;
    }
    .close:hover { color: red; }
    
    .messages-box {
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 10px;
      display: none;
      background-color: #2c2c2c;
    }
    
    .messages-box div {
      background: #1b1b1b;
      color: #f0f0f0;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 5px;
    }
    
    .spinner {
      border: 3px solid #333;
      border-top: 3px solid #FFD700;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-container {
      text-align: center;
      color: #aaa;
      padding: 20px;
    }
    
    .alert {
      padding: 10px;
      margin-top: 5px;
      display: none;
      border-radius: 5px;
    }
    .alert.success { background-color: #28a745; color: #fff; }
    .alert.error { background-color: #dc3545; color: #fff; }
    
    .profile-section {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .profile-picture {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #FFD700;
      cursor: pointer;
    }
    .profile-picture:hover {
      opacity: 0.8;
    }
    .upload-btn {
      background-color: #FFD700;
      color: #1b1b1b;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .upload-btn:hover {
      background-color: #FFC700;
    }
    
    /* Bitcoin Live Price Ticker */
    .btc-ticker {
      background: linear-gradient(135deg, #1b1b1b 0%, #2c2c2c 100%);
      border: 2px solid #FFD700;
      border-radius: 10px;
      padding: 15px 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }
    .btc-ticker-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .btc-icon {
      font-size: 2rem;
    }
    .btc-info h3 {
      color: #FFD700;
      margin: 0;
      font-size: 1.2rem;
    }
    .btc-price {
      font-size: 2rem;
      font-weight: bold;
      color: #fff;
      margin: 5px 0;
    }
    .btc-change {
      font-size: 0.9rem;
      padding: 3px 8px;
      border-radius: 5px;
    }
    .btc-change.up {
      background-color: #28a745;
      color: #fff;
    }
    .btc-change.down {
      background-color: #dc3545;
      color: #fff;
    }
    .btc-status {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #aaa;
      font-size: 0.85rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #28a745;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <header>
    <img src="B10CD185-B0B2-4ACF-9906-CF907D46B9D6.png" alt="TradeSphere Logo" class="logo">
    <h1>TradeSphere</h1>
    <button id="logoutBtn">Logout</button>
  </header>

  <div class="container">
    
    <!-- Bitcoin Live Price Ticker -->
    <div class="btc-ticker">
      <div class="btc-ticker-left">
        <div class="btc-icon">â‚¿</div>
        <div class="btc-info">
          <h3>Bitcoin (BTC/USDT)</h3>
          <div class="btc-price" id="btcLivePrice">$--,---</div>
          <span class="btc-change" id="btcChange">---%</span>
        </div>
      </div>
      <div class="btc-status">
        <span class="status-dot"></span>
        <span>Live</span>
      </div>
    </div>

    <section class="account-info card">
      <h2>Account Info</h2>
      <div class="profile-section">
        <div>
          <img id="profilePicture" 
               src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23333'/%3E%3Ctext x='50' y='60' font-size='40' text-anchor='middle' fill='%23FFD700'%3EðŸ‘¤%3C/text%3E%3C/svg%3E" 
               alt="Profile" 
               class="profile-picture"
               title="Click to change profile picture">
          <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
          <br>
          <button id="uploadPictureBtn" class="upload-btn">Change Photo</button>
        </div>
        <div>
          <p>Username: <span id="username">-</span></p>
          <p>Cash: $<span id="cash">0.00</span></p>
          <p>BTC: <span id="btc">0.000000</span> BTC</p>
        </div>
      </div>
    </section>

    <section class="withdrawals card">
      <h2>Withdrawals</h2>
      <table id="withdrawalsTable">
        <thead>
          <tr>
            <th>Amount</th>
            <th>Wallet</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="investments card">
      <h2>Investments</h2>
      <table id="investmentsTable">
        <thead>
          <tr>
            <th>Plan</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="withdraw card">
      <h2>Withdraw</h2>
      <form id="withdrawForm">
        <input type="number" id="withdrawAmount" placeholder="Amount" required>
        <input type="text" id="withdrawWallet" placeholder="Wallet Address" required>
        <button type="submit">Withdraw</button>
      </form>
      <div id="withdrawAlert" class="alert"></div>
    </section>

    <section class="support card">
      <h2>Support</h2>
      <button id="openSupportBtn">Open Chat</button>
      <div id="supportMessages" class="messages-box"></div>
      <form id="supportForm">
        <textarea id="supportMessage" placeholder="Type your message..." required></textarea>
        <button type="submit">Send</button>
      </form>
      <div id="supportAlert" class="alert"></div>
      <p class="support-contact">
        ðŸ“ž +1 (321) 283-6093<br>
        ðŸ“§ support@tradesphere.com
      </p>
    </section>

    <section class="about card">
      <button id="aboutBtn">About Company</button>
    </section>
  </div>

  <div id="aboutModal" class="modal">
    <div class="modal-content">
      <span class="close" id="aboutClose">&times;</span>
      <h2>About TradeSphere</h2>
      <p>
        Since 2020, <strong>TradeSphere</strong> has been a trusted broker platform dedicated to providing users with secure and reliable digital asset trading and investment opportunities. 
        Over the years, we have built a reputation for innovation, transparency, and client satisfaction. Our mission is simple: to empower every investor, regardless of experience level, 
        with the tools and support they need to succeed.  

        From seamless Bitcoin investments to professional support services, TradeSphere ensures every client's funds are handled with the highest standards of security.  
        Our advanced systems are built to protect assets while offering a smooth and professional trading experience.  

        Today, thousands of investors trust us for their financial growth. We remain committed to staying ahead of the market, 
        delivering excellence, and keeping every user happy with consistent, reliable service.  
        
        With TradeSphere, your success is our priority â€” and we continue to prove it every single day.
      </p>
    </div>
  </div>

  <footer>
    &copy; 2020 TradeSphere
  </footer>

  <script>
    const userId = localStorage.getItem('userId');
    if (!userId) window.location.href = 'index.html';

    const usernameSpan = document.getElementById('username');
    const cashSpan = document.getElementById('cash');
    const btcSpan = document.getElementById('btc');
    const withdrawalsTable = document.querySelector('#withdrawalsTable tbody');
    const investmentsTable = document.querySelector('#investmentsTable tbody');
    const withdrawAlert = document.getElementById('withdrawAlert');
    const supportAlert = document.getElementById('supportAlert'); 
    const supportMessagesBox = document.getElementById('supportMessages');
    const supportForm = document.getElementById('supportForm');
    const supportMessageInput = document.getElementById('supportMessage');
    const openSupportBtn = document.getElementById('openSupportBtn');
    const profilePicture = document.getElementById('profilePicture');
    const profilePictureInput = document.getElementById('profilePictureInput');
    const uploadPictureBtn = document.getElementById('uploadPictureBtn');

    const START_CASH = 50;
    let lastBtcPrice = null;

    // Binance WebSocket for Live Bitcoin Price with fallback
    function connectBinanceWebSocket() {
      const ws = new WebSocket('wss://stream.binance.com:443/ws/btcusdt@trade');
      
      ws.onopen = () => {
        console.log('Binance WebSocket connected');
        document.getElementById('btcLivePrice').textContent = 'Loading...';
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        const price = parseFloat(data.p);
        updateBitcoinPrice(price);
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        document.getElementById('btcLivePrice').textContent = 'Loading...';
        fetchBitcoinPriceHTTP();
      };

      ws.onclose = () => {
        console.log('WebSocket closed. Reconnecting in 5 seconds...');
        setTimeout(connectBinanceWebSocket, 5000);
      };
    }

    // HTTP Fallback for Bitcoin price
    function fetchBitcoinPriceHTTP() {
      fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT')
        .then(res => res.json())
        .then(data => {
          const price = parseFloat(data.price);
          updateBitcoinPrice(price);
          setTimeout(fetchBitcoinPriceHTTP, 5000);
        })
        .catch(err => {
          console.error('HTTP fallback error:', err);
          document.getElementById('btcLivePrice').textContent = 'Connection Error';
          setTimeout(fetchBitcoinPriceHTTP, 10000);
        });
    }

    function updateBitcoinPrice(price) {
      const priceElement = document.getElementById('btcLivePrice');
      const changeElement = document.getElementById('btcChange');
      
      priceElement.textContent = `$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      
      if (lastBtcPrice !== null) {
        const change = ((price - lastBtcPrice) / lastBtcPrice) * 100;
        const changeText = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;
        changeElement.textContent = changeText;
        changeElement.className = `btc-change ${change >= 0 ? 'up' : 'down'}`;
      }
      
      lastBtcPrice = price;
    }

    connectBinanceWebSocket();

    function showAlert(el, msg, isSuccess = true) {
      if (!el) return;
      el.textContent = msg;
      el.className = `alert ${isSuccess ? 'success' : 'error'}`;
      el.style.display = 'block';
      setTimeout(() => (el.style.display = 'none'), 3000);
    }
    
    function showLoadingSpinner(container) {
      container.innerHTML = '<div class="loading-container"><div class="spinner"></div><p>Loading...</p></div>';
    }

    async function fetchUserData() {
      try {
        const res = await fetch(`/user/${userId}`);
        const data = await res.json();
        if (!data.success) return;

        const user = data.user;
        usernameSpan.textContent = user.preferred_name || user.preferredName || user.username || 'Unknown';
        let cash = parseFloat(user.cash);
        if (isNaN(cash) || cash === null) cash = START_CASH;
        cashSpan.textContent = cash.toFixed(2);
        let btc = parseFloat(user.btc);
        if (isNaN(btc) || btc === null) btc = 0;
        btcSpan.textContent = btc.toFixed(6);

        if (user.profile_picture) {
          profilePicture.src = user.profile_picture;
        }

        renderWithdrawals(data.withdrawals || []);
        renderInvestments(data.investments || []);
        renderSupportMessages(data.supportMessages || []);
      } catch (err) {
        console.error('Error fetching user data:', err);
      }
    }

    function renderWithdrawals(withdrawals = []) {
      if (withdrawals.length === 0) {
        withdrawalsTable.innerHTML = `<tr><td colspan="4" style="text-align:center;">No withdrawals yet</td></tr>`;
        return;
      }
      withdrawalsTable.innerHTML = '';
      withdrawals.forEach(w => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${parseFloat(w.amount || 0).toFixed(2)}</td>
          <td>${w.wallet || '-'}</td>
          <td>${w.status || 'Pending'}</td>
          <td>${new Date(w.date || Date.now()).toLocaleString()}</td>
        `;
        withdrawalsTable.appendChild(row);
      });
    }

    function renderInvestments(investments = []) {
      if (investments.length === 0) {
        investmentsTable.innerHTML = `<tr><td colspan="4" style="text-align:center;">No investments yet</td></tr>`;
        return;
      }
      investmentsTable.innerHTML = '';
      investments.forEach(inv => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${inv.plan || '-'}</td>
          <td>${parseFloat(inv.amount || 0).toFixed(2)}</td>
          <td>${inv.status || 'Pending'}</td>
          <td>${new Date(inv.created_at || Date.now()).toLocaleString()}</td>
        `;
        investmentsTable.appendChild(row);
      });
    }

    function renderSupportMessages(messages = []) {
      if (!supportMessagesBox) return;
      
      if (messages.length === 0) {
        supportMessagesBox.innerHTML = `<p style="text-align:center;color:#aaa;">No messages yet.</p>`;
        supportMessagesBox._currentMessages = [];
        return;
      }
      
      supportMessagesBox.innerHTML = '';
      messages.forEach(msg => {
        const div = document.createElement('div');
        const senderLabel = msg.sender === 'user' ? 'You' : 'Support';
        div.innerHTML = `<strong>${senderLabel}:</strong> ${msg.message || msg.text || ''}<br>
        <small style="color:#888;">${new Date(msg.created_at || msg.date || Date.now()).toLocaleString()}</small>`;
        supportMessagesBox.appendChild(div);
      });
      supportMessagesBox.scrollTop = supportMessagesBox.scrollHeight;
      supportMessagesBox._currentMessages = messages;
    }

    uploadPictureBtn?.addEventListener('click', () => {
      profilePictureInput.click();
    });

    profilePicture?.addEventListener('click', () => {
      profilePictureInput.click();
    });

    profilePictureInput?.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (file.size > 2 * 1024 * 1024) {
        alert('Image too large! Maximum size is 2MB.');
        return;
      }

      if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (event) => {
        const imageData = event.target.result;
        
        try {
          const res = await fetch('/user/upload-picture', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, imageData })
          });
          const data = await res.json();
          
          if (data.success) {
            profilePicture.src = imageData;
            alert('Profile picture updated successfully!');
          } else {
            alert(data.message || 'Failed to upload picture');
          }
        } catch (err) {
          console.error('Upload error:', err);
          alert('Error uploading picture');
        }
      };
      
      reader.readAsDataURL(file);
    });

    document.getElementById('withdrawForm')?.addEventListener('submit', async e => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('withdrawAmount').value);
      const wallet = document.getElementById('withdrawWallet').value;
      try {
        const res = await fetch('/withdraw', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, amount, wallet })
        });
        const data = await res.json();
        showAlert(withdrawAlert, data.message, data.success);
        if (data.success) {
          fetchUserData();
          e.target.reset();
        }
      } catch (err) {
        showAlert(withdrawAlert, 'Error requesting withdrawal', false);
      }
    });

    supportForm?.addEventListener('submit', async e => {
      e.preventDefault();
      const message = supportMessageInput.value.trim();
      if (!message) return;
      try {
        const res = await fetch('/support/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, message })
        });
        const data = await res.json();
        if (data.success) {
          showAlert(supportAlert, 'Message sent to support!', true);
          const newMsg = { sender: 'user', message, created_at: Date.now() };
          const updatedMessages = [...(supportMessagesBox._currentMessages || []), newMsg];
          renderSupportMessages(updatedMessages);
          supportMessageInput.value = '';
        } else {
          showAlert(supportAlert, data.message || 'Failed to send message', false);
        }
      } catch (err) {
        showAlert(supportAlert, 'Error sending support message', false);
        console.error(err);
      }
    });

    openSupportBtn?.addEventListener('click', () => {
      if (supportMessagesBox.style.display === 'none' || supportMessagesBox.style.display === '') {
        supportMessagesBox.style.display = 'block';
        if (supportMessagesBox.innerHTML === '') {
          showLoadingSpinner(supportMessagesBox);
          setTimeout(() => fetchUserData(), 500);
        }
      } else {
        supportMessagesBox.style.display = 'none';
      }
    });

    const aboutBtn = document.getElementById('aboutBtn');
    const aboutModal = document.getElementById('aboutModal');
    const aboutClose = document.getElementById('aboutClose');

    if (aboutBtn && aboutModal && aboutClose) {
      aboutBtn.addEventListener('click', () => { aboutModal.style.display = 'block'; });
      aboutClose.addEventListener('click', () => { aboutModal.style.display = 'none'; });
      window.addEventListener('click', e => { if (e.target === aboutModal) aboutModal.style.display = 'none'; });
    }

    document.getElementById('logoutBtn')?.addEventListener('click', () => {
      localStorage.removeItem('userId');
      window.location.href = 'index.html';
    });

    fetchUserData();
    setInterval(fetchUserData, 5000);
  </script>
</body>
</html>
